{% extends '::base.html.twig' %}

{% block body %}

<div id="success-div" class="alert alert-success" role="alert" style="display: none"></div>
<div id="error-div" class="alert alert-danger" role="alert" style="display: none"></div>

<h4>Korisnici <span id="add-modal-button" class="glyphicon glyphicon-plus" style="cursor: pointer"></span></h4>
<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
  {% for res in resp %}
    <div class="panel panel-default">
      <div class="panel-heading" role="tab" id="heading-{{res.id}}">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-{{res.id}}" aria-expanded="false" aria-controls="collapse-{{res.id}}">
            {{res.korisnicko_ime}} 
          </a>
            <span id="edit-modal-button-{{res.id}}" class="glyphicon glyphicon-pencil edit-modal-button" style="cursor: pointer"></span>
            <span id="delete-modal-button-{{res.id}}" class="glyphicon glyphicon-trash delete-modal-button" style="cursor: pointer"></span>
        </h4>
      </div>
      <div id="collapse-{{res.id}}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading-{{res.id}}">
        <div class="panel-body">
          <ul class="list-group">
            <li class="list-group-item">
              <span><b>Korisničko ime: </b></span>
              <span class="korisnik">{{res.korisnicko_ime}}</span>
            </li>
            <li class="list-group-item">
              <span><b>Lozinka: </b></span>
              <span class="lozinka">{{res.lozinka}}</span>
            </li>
            <li class="list-group-item">
              <span><b>Ime: </b></span>
              <span class="ime">{{res.ime}}</span>
            </li>
            <li class="list-group-item">
              <span><b>Prezime: </b></span>
              <span class="prezime">{{res.prezime}}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<div class="modal fade" id="edit-modal" tabindex="-1" role="dialog" aria-labelledby="edit-modal-label">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="edit-modal-label">Uredi podatke</h4>
      </div>
      <input type="hidden" class="edit-modal-id">
      <div class="modal-body">
        <div class="input-group">
          <span class="input-group-addon" id="edit-korisnik-addon">Korisničko ime</span>
          <input type="text" class="form-control korisnik" aria-describedby="edit-korisnik-addon">
        </div>
        <br>
        <div class="input-group">
          <span class="input-group-addon" id="edit-lozinka-addon">Lozinka</span>
          <input type="text" class="form-control lozinka" aria-describedby="edit-lozinka-addon">
        </div>
        <br>
        <div class="input-group">
          <span class="input-group-addon" id="edit-ime-addon">Ime</span>
          <input type="text" class="form-control ime" aria-describedby="edit-ime-addon">
        </div>
        <br>
        <div class="input-group">
          <span class="input-group-addon" id="edit-prezime-addon">Prezime</span>
          <input type="text" class="form-control prezime" aria-describedby="edit-prezime-addon">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Odustani</button>
        <button type="button" id="edit-modal-save" class="btn btn-primary">Spremi promjene</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="delete-modal" tabindex="-1" role="dialog" aria-labelledby="delete-modal-label">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <input type="hidden" id="pom-delete-id">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="delete-modal-label">Brisanje korisnika</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Odustani</button>
        <button type="button" id="confirm-delete" class="btn btn-primary">Obriši korisnika</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="add-modal" tabindex="-1" role="dialog" aria-labelledby="add-modal-label">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="add-modal-label">Dodaj novog korisnika</h4>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <span class="input-group-addon" id="add-korisnik-addon">Korisničko ime</span>
          <input type="text" class="form-control korisnik" aria-describedby="add-korisnik-addon">
        </div>
        <br>
        <div class="input-group">
          <span class="input-group-addon" id="add-lozinka-addon">Lozinka</span>
          <input type="text" class="form-control lozinka" aria-describedby="add-lozinka-addon">
        </div>
        <br>
        <div class="input-group">
          <span class="input-group-addon" id="add-ime-addon">Ime</span>
          <input type="text" class="form-control ime" aria-describedby="add-ime-addon">
        </div>
        <br>
        <div class="input-group">
          <span class="input-group-addon" id="add-prezime-addon">Prezime</span>
          <input type="text" class="form-control prezime" aria-describedby="add-prezime-addon">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Odustani</button>
        <button type="button" id="add-modal-save" class="btn btn-primary">Dodaj korisnika</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
<script>
  $(document).on('click', '.edit-modal-button', function(){ 
    var id = $(this).attr('id').substr(18);
    var korisnik = $(this).closest('.panel-default').find('.korisnik').text();
    var lozinka = $(this).closest('.panel-default').find('.lozinka').text();
    var ime = $(this).closest('.panel-default').find('.ime').text();
    var prezime = $(this).closest('.panel-default').find('.prezime').text();
    $(".edit-modal-id").attr('id', id);
    $("#edit-modal .korisnik").val(korisnik);
    $("#edit-modal .lozinka").val(lozinka);
    $("#edit-modal .ime").val(ime);
    $("#edit-modal .prezime").val(prezime);
    $("#edit-modal").modal('show');
  });
  
  $(document).on('click', '#edit-modal-save', function(){
    $("#edit-modal").prop('disabled', 'true');
    var id = $(this).closest('.modal-content').find('.edit-modal-id').attr('id');
    var korisnik = $(this).closest('.modal-content').find('.korisnik').val();
    var lozinka = $(this).closest('.modal-content').find('.lozinka').val();
    var ime = $(this).closest('.modal-content').find('.ime').val();
    var prezime = $(this).closest('.modal-content').find('.prezime').val();
    
    var data = JSON.stringify({
      id: id,
      korisnik: korisnik,
      lozinka: lozinka,
      ime: ime,
      prezime: prezime
    });
    
    $.ajax({
      url: "{{path('korisnici_uredi')}}",
      type: "POST",
      data:data,
      success:function (msg) {
        $("#heading-" + id + " a").html(korisnik);
        $("#collapse-" + id + " .korisnik").html(korisnik);
        $("#collapse-" + id + " .lozinka").html(lozinka);
        $("#collapse-" + id + " .ime").html(ime);
        $("#collapse-" + id + " .prezime").html(prezime);
        
        $("#success-div").html('Uspješno spremljene promjene!');
        $("#edit-modal").prop('disabled', 'false');
        $("#edit-modal").modal('hide');
        $("#error-div").hide();
        $("#success-div").show();
      }
    });
  });
  
  $(document).on('click', '.delete-modal-button', function(){ 
    var id = $(this).attr('id').substr(20);
    var korisnik = $(this).closest('.panel-default').find('.korisnik').text();
    $("#pom-delete-id").val(id);
    $("#delete-modal .modal-body").html('Želite li sigurno obrisati korisnika: <b>' + korisnik + '</b>?');
    $("#delete-modal").modal('show');
  });
  
  $(document).on('click', '#confirm-delete', function() {
    var id = $("#pom-delete-id").val();
    
    $.ajax({
      url: "{{path('korisnici_obrisi')}}",
      type: "POST",
      data: {'id': id},
      success:function (msg) {
        $("#collapse-" + id).closest('.panel-default').remove();
        
        
        $("#success-div").html('Uspješno obrisan korisnik!');
        $("#delete-modal").prop('disabled', 'false');
        $("#delete-modal").modal('hide');
        $("#error-div").hide();
        $("#success-div").show();
      }
    });
  });
  
  $(document).on('click', '#add-modal-button', function(){ 
    $("#add-modal").modal('show');
  });
  
  $(document).on('click', '#add-modal-save', function(){ 
    $("#add-modal").prop('disabled', 'true');
    var korisnik = $(this).closest('.modal-content').find('.korisnik').val();
    var lozinka = $(this).closest('.modal-content').find('.lozinka').val();
    var ime = $(this).closest('.modal-content').find('.ime').val();
    var prezime = $(this).closest('.modal-content').find('.prezime').val();
    
    var data = JSON.stringify({
      korisnik: korisnik,
      lozinka: lozinka,
      ime: ime,
      prezime: prezime
    });

    $.ajax({
      url: "{{path('korisnici_novi')}}",
      type: "POST",
      data:data,
      success:function (id) {
        var novi = '<div class="panel panel-default">\
          <div class="panel-heading" role="tab" id="heading-' + id.id + '">\
            <h4 class="panel-title">\
              <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse-' + id.id + '" aria-expanded="false" aria-controls="collapse-' + id.id + '">\
                ' + korisnik + ' \
              </a>\
                <span id="edit-modal-button-' + id.id + '" class="glyphicon glyphicon-pencil edit-modal-button" style="cursor: pointer"></span> \
                <span id="delete-modal-button-' + id.id + '" class="glyphicon glyphicon-trash delete-modal-button" style="cursor: pointer"></span> \
            </h4>\
          </div>\
          <div id="collapse-' + id.id + '" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading-' + id.id + '">\
            <div class="panel-body">\
              <ul class="list-group">\
                <li class="list-group-item">\
                  <span><b>Korisničko ime: </b></span>\
                  <span class="korisnik">' + korisnik + '</span>\
                </li>\
                <li class="list-group-item">\
                  <span><b>Lozinka: </b></span>\
                  <span class="lozinka">' + lozinka + '</span>\
                </li>\
                <li class="list-group-item">\
                  <span><b>Ime: </b></span>\
                  <span class="ime">' + ime + '</span>\
                </li>\
                <li class="list-group-item">\
                  <span><b>Prezime: </b></span>\
                  <span class="prezime">' + prezime + '</span>\
                </li>\
              </ul>\
            </div>\
          </div>\
        </div>'
        
        $(".panel-group").append(novi);
        
        $("#success-div").html('Uspješno dodan novi korisnik!');
        $("#add-modal").prop('disabled', 'false');
        $("#add-modal").modal('hide');
        
        $("#add-modal").find('.korisnik').val('');
        $("#add-modal").find('.lozinka').val('');
        $("#add-modal").find('.ime').val('');
        $("#add-modal").find('.prezime').val('');
        
        $("#error-div").hide();
        $("#success-div").show();
      }
    });
  });
</script>
<p id="ispis"></p>
{% endblock %}